<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>FollowUP ‚Äì Comercial</title>
  <link rel="icon" href="https://media.licdn.com/dms/image/v2/D4E0BAQFvVz5clxj08w/company-logo_200_200/B4EZXyyjtSG0AI-/0/1743535094994/followupcx_logo?e=2147483647&v=beta&t=FVh7RUdEGOzXdcCx5TXmlVWeh3MfenVzm9HDifB-B0k" type="image/png">
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>

  <style>
    :root{
      --brand:#0f6eea; --brand-600:#0a55b6; --ink:#0f172a; --muted:#637488;
      --ok:#16a34a; --warn:#ef4444; --bg:#f5f7fb; --card:#ffffff; --chip:#e6eefc;
      --radius:14px; --shadow:0 6px 24px rgba(15, 23, 42, .06);
      --kpi-gap:16px; --sidebar-w:264px; --topbar-h:56px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial; color:var(--ink); background:var(--bg); display:flex;}

    /* Layout base */
    .shell{display:flex; width:100%; min-height:100svh; overflow:hidden}
    .sidebar{
      width:var(--sidebar-w); min-width:var(--sidebar-w);
      background:linear-gradient(180deg, var(--brand), var(--brand-600));
      color:#fff; padding:18px; display:flex; flex-direction:column; gap:12px; z-index:19;
      transition:transform .2s ease;
    }
    .brand{display:flex; align-items:center; justify-content:space-between; gap:10px; font-weight:800}
    .nav{margin-top:10px; display:flex; flex-direction:column; gap:6px}
    .nav a{color:#fff; text-decoration:none; padding:10px 12px; border-radius:10px; display:flex; align-items:center; gap:8px; opacity:.92}
    .nav a[aria-current="page"], .nav a:hover{background:rgba(255,255,255,.14); opacity:1}
    .sidebar small{opacity:.8}

    .main{flex:1; display:flex; flex-direction:column; min-width:0;}
    .topbar{display:none; position:sticky; top:0; z-index:20; height:var(--topbar-h);
      background:linear-gradient(180deg, var(--brand), var(--brand-600)); color:#fff; padding:0 12px; align-items:center; gap:8px;}
    .topbar h1{font-size:16px; margin:0; font-weight:800}
    .hamb{appearance:none;border:0;background:transparent;color:#fff;font-size:22px;line-height:1; padding:8px 10px; border-radius:10px; cursor:pointer}

    .page{flex:1; overflow:auto; overflow-x:hidden; padding:18px; position:relative; min-width:0;}

    /* Cards & chips */
    .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; width:100%; max-width:100%}
    .card.title{display:flex; align-items:center; justify-content:space-between; padding:18px; gap:12px}
    .pill{background:#f1f5ff;border:1px solid #e3ecff;color:#173f82;border-radius:999px;padding:6px 10px;font-size:12px}
    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{background:var(--chip); color:#17438a; padding:6px 10px; border-radius:999px; font-size:12px; cursor:default}
    .chip.reset{cursor:pointer}
    .btn{appearance:none; border:1px solid #e7ecf7; background:#fff; color:#173f82; border-radius:10px; padding:10px 12px; cursor:pointer; min-height:40px; font-weight:600}
    .btn:active{transform:scale(.98)}

    .filters-bar{ position:sticky; top:0; z-index:5; background:var(--bg); margin-bottom:14px; }
    details.filters{width:100%; border:1px solid #e7ecf7; border-radius:12px; background:#fff; box-shadow:var(--shadow);}
    details.filters > summary{list-style:none; cursor:pointer; padding:12px 14px; font-weight:700; color:#173f82; display:flex; align-items:center; justify-content:space-between;}
    details.filters > summary::-webkit-details-marker{display:none}
    details.filters[open] > summary{border-bottom:1px solid #e7ecf7}
    .filters-inner{padding:12px}
    .filters-grid{display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); align-items:end;}
    .field{display:flex; flex-direction:column; gap:6px}
    label{font-size:12px; color:var(--muted)}
    select,button.export{appearance:none; width:100%; padding:12px 12px; border-radius:10px; background:#fff; border:1px solid #e7ecf7; outline:none; color:var(--ink); font-size:14px; min-height:40px;}

    /* Grid */
    .section{margin-top:16px; display:grid; gap:14px; grid-template-columns:repeat(12,1fr)}
    .span-12{grid-column:span 12}.span-8{grid-column:span 8}.span-6{grid-column:span 6}.span-4{grid-column:span 4}
    @media (max-width:1200px){ .span-8,.span-6,.span-4{grid-column:span 12} }

    /* KPIs (con tipograf√≠a adaptable para evitar overflow) */
    .kpis{display:grid; grid-template-columns: repeat(auto-fit, minmax(210px, 1fr)); gap: var(--kpi-gap)}
    .card.kpi{ padding:18px 18px 14px; border:1px solid #e7ecf7; border-radius:18px; box-shadow:0 10px 30px rgba(15,23,42,.08); container-type:inline-size; }
    .kpi h4{ margin:0 0 8px; font-size:14px; color:#4b5870; letter-spacing:.2px; display:flex; align-items:center; gap:6px;}
    .kpi .v{
      font-size:clamp(22px, 12cqw, 38px);
      line-height:1; font-weight:900; letter-spacing:.2px; color:#111827; margin-bottom:6px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .delta{ display:inline-flex; align-items:center; gap:6px; font-size:13px; font-weight:600; }
    .delta.up{ color:#16a34a; } .delta.down{ color:#ef4444; }

    /* Tooltip (accesible) */
    .tooltip{position:relative; display:inline-flex; align-items:center; cursor:help; outline:none}
    .tooltip .i{width:18px;height:18px;border-radius:50%;background:#e6eefc;color:#173f82;display:inline-flex;align-items:center;justify-content:center;font-weight:800;font-size:12px;line-height:1}
    .tooltip .tip{
      position:absolute; left:100%; top:50%; transform:translateY(-50%);
      background:#0f172a; color:#fff; padding:8px 10px; border-radius:8px; font-size:12px;
      box-shadow:0 10px 30px rgba(15,23,42,.25); width:max-content; max-width:280px; margin-left:8px; z-index:30;
      opacity:0; visibility:hidden; transition:opacity .12s ease;
    }
    .tooltip:focus .tip, .tooltip:hover .tip{opacity:1; visibility:visible}
    .muted{color:var(--muted)}

    /* Charts */
    .chart{width:100%; max-width:100%; min-height:320px; height:clamp(300px, 48vh, 420px)}
    .chart.tall{min-height:420px; height:clamp(380px, 56vh, 520px)}

    /* Responsive m√≥vil: sidebar como drawer */
    @media (max-width: 900px){
      .topbar{display:flex}
      .sidebar{position:fixed; inset:0 auto 0 0; height:100svh; transform:translateX(-100%); box-shadow: 18px 0 40px rgba(4,14,46,.2);}
      .sidebar.open{transform:translateX(0)}
      .page{padding:14px}
      .kpis{grid-template-columns: 1fr}
      .section{grid-template-columns: 1fr}
    }
    @media (min-width:901px){
      details.filters > summary{display:none}
      details.filters[open] > .filters-inner{padding-top:0}
    }
  </style>
</head>
<body>
  <div class="shell" id="shell">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar" role="navigation" aria-label="M√≥dulos de reportes">
      <div class="brand" aria-label="FollowUP">
        <span>FollowUP Reports</span>
        <button class="hamb" id="closeNav" aria-label="Ocultar men√∫">‚úï</button>
      </div>
      <nav class="nav">
        <a id="lnk-bienvenida" href="Bienvenida.html">üè† Bienvenida</a>
        <a id="lnk-dashboard" href="Dashboard.html">üìä Dashboard</a>
        <a id="lnk-recorridos" href="Recorridos.html">üó∫Ô∏è Recorridos</a>
        <a id="lnk-buyer" href="Buyer.html">üßë‚Äçü§ù‚Äçüßë Buyer Persona</a>
        <a id="lnk-staff" href="Staff.html">üë§ Staff</a>
        <a id="lnk-comercial" href="Comercial.html" aria-current="page">üìà Comercial</a>
      </nav>
      <div style="margin-top:auto"><small>Tu espacio comercial</small></div>
    </aside>

    <div class="main">
      <!-- Topbar m√≥vil -->
      <div class="topbar">
        <button class="hamb" id="openNav" aria-label="Abrir men√∫">‚ò∞</button>
        <h1>Comercial</h1>
      </div>

      <main class="page" role="main">
        <!-- Filtros -->
        <header class="filters-bar" role="region" aria-label="Filtros comerciales">
          <details class="filters card" id="filters" open>
            <summary>Filtros ‚ñæ</summary>
            <div class="filters-inner">
              <div class="filters-grid">
                <div class="field">
                  <label for="f-fecha">Rango de fechas</label>
                  <select id="f-fecha">
                    <option value="7">√öltimos 7 d√≠as</option>
                    <option value="14" selected>√öltimos 14 d√≠as</option>
                    <option value="30">√öltimos 30 d√≠as</option>
                  </select>
                </div>
                <div class="field">
                  <label for="f-genero">G√©nero</label>
                  <select id="f-genero">
                    <option value="all" selected>Todos</option>
                    <option value="Femenino">Femenino</option>
                    <option value="Masculino">Masculino</option>
                  </select>
                </div>
                <div class="field">
                  <label for="f-edad">Rango etario</label>
                  <select id="f-edad">
                    <option value="all" selected>Todos</option>
                    <option value="Ni√±o">Ni√±o</option>
                    <option value="Adulto Joven">Adulto Joven</option>
                    <option value="Adulto">Adulto</option>
                    <option value="Senior">Senior</option>
                  </select>
                </div>
                <div class="field">
                  <label for="f-zona">Zona</label>
                  <select id="f-zona">
                    <option value="all" selected>Todas</option>
                    <option>Pasillo</option><option>Vitrina</option><option>Tienda</option>
                    <option>Perfumer√≠a</option><option>Zapater√≠a</option><option>Joyer√≠a</option>
                    <option>Carteras</option><option>Tane</option><option>Caja</option>
                  </select>
                </div>
                <div class="field">
                  <label for="f-persona">Tipo de grupo</label>
                  <select id="f-persona">
                    <option value="all" selected>Todos</option>
                    <option value="Solo">Solo</option>
                    <option value="Pareja">Pareja</option>
                    <option value="Amigos">Amigos</option>
                    <option value="Familia">Familia</option>
                  </select>
                </div>
                <div class="field">
                  <label>Vista</label>
                  <div class="chips">
                    <span class="chip" id="chip-rango">14 d√≠as</span>
                    <span class="chip" id="chip-filtros">Sin filtros</span>
                    <button class="export" id="btn-export">Exportar CSV (dataset comercial filtrado)</button>
                  </div>
                </div>
              </div>
            </div>
          </details>
        </header>

        <!-- T√≠tulo -->
        <div class="card title" style="margin-bottom:16px;">
          <h2 style="margin:0">Comercial ‚Äì Insights de venta + recorrido</h2>
          <span class="pill">Ventas, Art. x Ticket, SPV y eficiencia por zona</span>
        </div>
        
        <div class="card span-12" id="insights-card" style="margin-bottom:16px;">
          <h3 style="margin:0 0 8px">Insights autom√°ticos</h3>
          <ul id="insights-list" class="muted" style="margin:0 0 6px 18px"></ul>
        </div>

        <!-- KPIs (con tooltips explicativos) -->
        <div class="kpis" role="region" aria-label="Indicadores Comerciales">
          <div class="card kpi"><h4>Ventas</h4><div class="v" id="kpi-sales">‚Äì</div><div class="delta up" id="kpi-sales-var">‚Äì</div></div>

          <div class="card kpi"><h4>Tickets</h4><div class="v" id="kpi-tickets">‚Äì</div><div class="delta up" id="kpi-tickets-var">‚Äì</div></div>

          <div class="card kpi"><h4>Ticket Promedio</h4><div class="v" id="kpi-atv">‚Äì</div><div class="delta up" id="kpi-atv-var">‚Äì</div></div>

          <div class="card kpi">
            <h4>Art.x Ticket
              <span class="tooltip" tabindex="0" aria-label="UPT: Unidades por ticket. Promedio de art√≠culos vendidos en cada ticket; √∫til para detectar oportunidades de upsell/cross-sell.">
                <span class="i">i</span><span class="tip" role="tooltip">Promedio de art√≠culos vendidos en cada ticket; √∫til para detectar oportunidades de upsell / cross-sell.</span>
              </span>
            </h4>
            <div class="v" id="kpi-upt">‚Äì</div><div class="delta up" id="kpi-upt-var">‚Äì</div>
          </div>

          <div class="card kpi">
            <h4>Visitantes</h4>
            <div class="v" id="kpi-visitors">‚Äì</div><div class="delta up" id="kpi-visitors-var">‚Äì</div>
          </div>

          <div class="card kpi">
            <h4>SPV
              <span class="tooltip" tabindex="0" aria-label="SPV (Spend per Visitor): Ventas totales divididas por el n√∫mero de visitantes filtrados. Indica el gasto promedio por visitante.">
                <span class="i">i</span><span class="tip" role="tooltip">SPV (Spend per Visitor): Ventas totales divididas por el n√∫mero de visitantes filtrados. Indica el gasto promedio por visitante.</span>
              </span>
            </h4>
            <div class="v" id="kpi-spv">‚Äì</div><div class="delta up" id="kpi-spv-var">‚Äì</div>
          </div>

          <div class="card kpi">
            <h4>Yield por Zona
              <span class="tooltip" tabindex="0" aria-label="Yield por Zona: Ventas atribuidas a una zona dividido por visitantes que pasaron por esa zona. Si est√° 'Todas', se muestra el promedio de las zonas principales.">
                <span class="i">i</span><span class="tip" role="tooltip">Yield por Zona: Ventas atribuidas a una zona √∑ visitantes que pasaron por esa zona. Si est√° ‚ÄúTodas‚Äù, se muestra el promedio de las zonas principales.</span>
              </span>
            </h4>
            <div class="v" id="kpi-yield">‚Äì</div><div class="delta up" id="kpi-yield-var">‚Äì</div>
          </div>

          <div class="card kpi">
            <h4>CEI
              <span class="tooltip" tabindex="0" aria-label="CEI (Commercial Efficiency Index): Ventas divididas por visitantes ponderados por su tiempo en tienda (dwell relativo). Mide eficiencia comercial, no conversi√≥n.">
                <span class="i">i</span><span class="tip" role="tooltip">CEI (Commercial Efficiency Index): Ventas √∑ visitantes ponderados por su tiempo en tienda (dwell relativo). Mide eficiencia comercial, no conversi√≥n.</span>
              </span>
            </h4>
            <div class="v" id="kpi-cei">‚Äì</div><div class="delta up" id="kpi-cei-var">‚Äì</div>
          </div>
        </div>

        <!-- Secciones (cada t√≠tulo con tooltip explicativo) -->
        <section class="section">
          <div class="card span-8">
            <h3 style="margin:0 0 8px; display:flex; align-items:center; gap:6px">
              Tendencia Ventas & SPV
              <span class="tooltip" tabindex="0" aria-label="L√≠neas con eje dual: Ventas diarias (CLP) y gasto por visitante (SPV). √ötil para ver si sube el gasto sin depender de m√°s tr√°fico.">
                <span class="i">i</span><span class="tip" role="tooltip">L√≠neas con eje dual: Ventas diarias (CLP) y gasto por visitante (SPV). √ötil para ver si sube el gasto sin depender de m√°s tr√°fico.</span>
              </span>
            </h3>
            <p class="muted" style="margin:0 0 8px">Eje izquierdo CLP; derecho CLP/visitante. Puedes hacer zoom.</p>
            <div id="ch-trend" class="chart"></div>
          </div>

          <div class="card span-4">
            <h3 style="margin:0 0 8px; display:flex; align-items:center; gap:6px">
              Mix de ventas por zona (apilado por grupo)
              <span class="tooltip" tabindex="0" aria-label="Barras apiladas por tipo de grupo (Solo, Pareja, etc.). Muestra el mix de ventas por zona; clic para fijar la zona como filtro.">
                <span class="i">i</span><span class="tip" role="tooltip">Barras apiladas por tipo de grupo (Solo, Pareja, etc.). Muestra el mix de ventas por zona; clic para fijar la zona como filtro.</span>
              </span>
            </h3>
            <div id="ch-mix-zone" class="chart"></div>
          </div>

          <div class="card span-6">
            <h3 style="margin:0 0 8px; display:flex; align-items:center; gap:6px">
              Art. x Ticket vs Ticket Promedio por zona
              <span class="tooltip" tabindex="0" aria-label="Gr√°fico de burbujas: X=UPT, Y=Ticket Promedio, tama√±o=Ventas. Los cuadrantes ayudan a detectar oportunidades de upsell y pricing.">
                <span class="i">i</span><span class="tip" role="tooltip">Burbuja: X=Art. x Ticket, Y=Ticket Promedio, tama√±o=Ventas. Cuadrantes revelan oportunidades de upsell y pricing.</span>
              </span>
            </h3>
            <div id="ch-bubble" class="chart"></div>
          </div>

          <div class="card span-6">
            <h3 style="margin:0 0 8px; display:flex; align-items:center; gap:6px">
              Heatmap ventas por hora √ó zona
              <span class="tooltip" tabindex="0" aria-label="Monto vendido estimado por hora y zona de influencia del ticket. Clic en un cuadro para filtrar la zona.">
                <span class="i">i</span><span class="tip" role="tooltip">Monto vendido estimado por hora y zona de influencia del ticket. Clic en un cuadro para filtrar la zona.</span>
              </span>
            </h3>
            <div id="ch-heat" class="chart"></div>
          </div>

          <div class="card span-6">
            <h3 style="margin:0 0 8px; display:flex; align-items:center; gap:6px">
              Co-ocurrencia de categor√≠as (cross-sell)
              <span class="tooltip" tabindex="0" aria-label="Frecuencia con la que pares de zonas aparecen en el mismo recorrido previo a una compra. Sugerencias para bundling y planogramas.">
                <span class="i">i</span><span class="tip" role="tooltip">Frecuencia con la que pares de zonas aparecen en el mismo recorrido previo a una compra. √ötil para bundling y planogramas.</span>
              </span>
            </h3>
            <div id="ch-cross" class="chart"></div>
          </div>

          <div class="card span-6">
            <h3 style="margin:0 0 8px; display:flex; align-items:center; gap:6px">
              Distribuci√≥n del tama√±o de ticket
              <span class="tooltip" tabindex="0" aria-label="Histograma del monto por ticket. Las l√≠neas verticales marcan los percentiles P25, P50 (mediana) y P75.">
                <span class="i">i</span><span class="tip" role="tooltip">Histograma del monto por ticket. Las l√≠neas verticales marcan P25, P50 (mediana) y P75.</span>
              </span>
            </h3>
            <div id="ch-hist" class="chart"></div>
          </div>

          <div class="card span-12">
            <h3 style="margin:0 0 8px; display:flex; align-items:center; gap:6px">
              Ranking CEI por zona
              <span class="tooltip" tabindex="0" aria-label="Mayor CEI = mejores ventas para una misma afluencia ponderada por tiempo (dwell). Compara eficiencia comercial entre zonas.">
                <span class="i">i</span><span class="tip" role="tooltip">Mayor CEI = mejores ventas para una misma afluencia ponderada por tiempo (dwell). Compara eficiencia comercial entre zonas.</span>
              </span>
            </h3>
            <div id="ch-cei" class="chart"></div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
  (function(){
    const safe = fn => (...a) => { try{ return fn(...a);}catch(e){ console.error(e); } };

    // ====== Filtros persistentes ======
    const DEFAULT_FILTERS = Object.freeze({
      range:14, genero:'all', edad:'all', zona:'all', persona:'all', staffMode:'exclude'
    });
    const STORAGE_KEY = 'palacioFilters';

    const ALLOWED = {
      genero:['all','Femenino','Masculino'],
      edad:['all','Ni√±o','Adulto Joven','Adulto','Senior'],
      persona:['all','Solo','Pareja','Amigos','Familia'],
      zona:null // validamos a posteriori contra "zones"
    };

    function readQuery(){
      const q = new URLSearchParams(location.search);
      const obj = {}; for (const [k,v] of q.entries()) obj[k]=v; return obj;
    }
    function serializeQuery(f){
      const q = new URLSearchParams();
      q.set('range', String(f.range));
      if (f.genero!=='all') q.set('genero', f.genero);
      if (f.edad!=='all') q.set('edad', f.edad);
      if (f.zona!=='all') q.set('zona', f.zona);
      if (f.persona!=='all') q.set('persona', f.persona);
      if (f.staffMode!=='exclude') q.set('staffMode', f.staffMode);
      return q.toString();
    }
    function buildHref(base, f){ const qs = serializeQuery(f); return base + (qs? '?'+qs:''); }

    // Normaliza y sanea filtros (evita rangos inv√°lidos que hac√≠an caer todo a 0)
    function normalizeFilters(f){
      const out = {...DEFAULT_FILTERS, ...f};
      out.range = Math.min(30, Math.max(1, parseInt(out.range,10) || DEFAULT_FILTERS.range));
      if (!ALLOWED.genero.includes(out.genero)) out.genero='all';
      if (!ALLOWED.edad.includes(out.edad)) out.edad='all';
      if (!ALLOWED.persona.includes(out.persona)) out.persona='all';
      // zona se valida luego de definir "zones"; si no coincide, all
      return out;
    }

    function loadFilters(){
      const fromStorage = (()=>{ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'null'); }catch{ return null; }})();
      const fromQuery = readQuery();
      let f = {...DEFAULT_FILTERS, ...(fromStorage||{})};
      if (fromQuery.range) f.range = fromQuery.range;
      if (fromQuery.genero) f.genero = fromQuery.genero;
      if (fromQuery.edad) f.edad = fromQuery.edad;
      if (fromQuery.zona) f.zona = fromQuery.zona;
      if (fromQuery.persona) f.persona = fromQuery.persona;
      if (fromQuery.staffMode) f.staffMode = fromQuery.staffMode;
      f = normalizeFilters(f); // primera normalizaci√≥n
      return f;
    }
    function saveFilters(f, updateURL){
      const normalized = normalizeFilters(f);
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(normalized)); }catch(e){}
      if (updateURL){ const qs=serializeQuery(normalized); history.replaceState(null, '', location.pathname + (qs? '?'+qs:'')); }
    }

    // ====== Datos sint√©ticos ======
    const rand = (seed => () => (seed = (seed * 9301 + 49297) % 233280) / 233280)(101); // determinista
    const genders = ["Femenino", "Masculino"];
    const ages = ["Ni√±o", "Adulto Joven", "Adulto", "Senior"];
    const zones = ["Pasillo","Vitrina","Tienda","Perfumer√≠a","Zapater√≠a","Joyer√≠a","Carteras","Tane","Caja"];
    const personas = ["Solo","Pareja","Amigos","Familia"];

    // Si zona no es v√°lida, volver a 'all'
    let filters = loadFilters();
    if (filters.zona!=='all' && !zones.includes(filters.zona)) filters.zona='all';
    // Persistimos la versi√≥n saneada en URL + storage (evita entrar con rango inv√°lido)
    saveFilters(filters, true);

    function randomHour(){
      const r = rand();
      if (r < 0.15) return 10 + Math.floor(rand()*3);
      if (r < 0.55) return 13 + Math.floor(rand()*3);
      if (r < 0.80) return 16 + Math.floor(rand()*2);
      return 18 + Math.floor(rand()*3);
    }

    // VISITAS (30 d√≠as)
    const ALL_VISITS = (() => {
      const visits = [];
      for (let d=0; d<30; d++){
        const dayBase = 55 + Math.floor(rand()*65);
        for (let i=0; i<dayBase; i++){
          const g = genders[Math.floor(rand()*genders.length)];
          const a = ages[Math.floor(Math.pow(rand(), .6)*ages.length)];
          const p = personas[Math.floor(Math.pow(rand(), .85)*personas.length)];
          const unique = rand() > 0.18;
          const len = 3 + Math.floor(rand()*5);
          const path = [];
          let current = ["Pasillo","Vitrina","Tienda"][Math.floor(rand()*3)];
          for (let k=0; k<len; k++){
            path.push(current);
            const nextCandidates = zones.filter(z => z !== current);
            current = nextCandidates[Math.floor(rand()*nextCandidates.length)];
          }
          if (rand() < .35 && !path.includes('Caja')) path[path.length-1] = 'Caja';
          const dwell = 7 + Math.round(rand()*26) + (a==="Ni√±o"? -2: a==="Senior"? +3: 0) + (p==="Familia"? +2: 0);
          const startHour = randomHour();
          visits.push({day:d, hour:startHour, gender:g, age:a, persona:p, path, dwell:Math.max(4,dwell), unique});
        }
      }
      return visits;
    })();

    // TICKETS desde VISITAS
    function lognormal(mu, sigma){
      const u1 = Math.max(Number.EPSILON, rand());
      const u2 = Math.max(Number.EPSILON, rand());
      const z = Math.sqrt(-2.0*Math.log(u1)) * Math.cos(2*Math.PI*u2);
      return Math.exp(mu + sigma*z);
    }
    const ALL_TICKETS = (() => {
      const out = []; let id = 1;
      for (const v of ALL_VISITS){
        if (rand() < 0.38){
          const items = 1 + (rand()<.15?0:1) + (rand()<.55?1:0) + (rand()<.25?1:0) + (rand()<.10?1:0);
          const base = 12000 + Math.floor(rand()*8000);
          const noise = lognormal(Math.log(1.0), 0.35);
          const amount = Math.round(Math.max(4000, items * base * noise));
          const avgItemPrice = Math.round(amount / Math.max(1, items));
          const path = v.path.slice();
          let zoneInfluence = 'Tienda';
          if (path.includes('Caja')){
            const idx = path.lastIndexOf('Caja');
            const prev = path.slice(0, idx).filter(z => z!=='Caja');
            zoneInfluence = prev.length? prev[prev.length-1] : 'Tienda';
          }else{
            const cand = path.filter(z => z!=='Caja');
            zoneInfluence = cand.length ? cand[Math.floor(rand()*cand.length)] : 'Tienda';
          }
          out.push({ ticketId:String(id++).padStart(6,'0'), day:v.day, hour:v.hour, zone:zoneInfluence,
            items, amount, avgItemPrice, persona:v.persona, gender:v.gender, age:v.age, path:v.path });
        }
      }
      return out;
    })();

    // ====== Estado & helpers ======
    const $ = s => document.querySelector(s);

    function updateFilterUI(){
      $('#f-fecha').value = String(filters.range);
      $('#f-genero').value = filters.genero;
      $('#f-edad').value = filters.edad;
      $('#f-zona').value = filters.zona;
      $('#f-persona').value = filters.persona;

      $('#chip-rango').textContent = `${filters.range} d√≠as`;
      const actives = [];
      if (filters.genero!=='all') actives.push(filters.genero);
      if (filters.edad!=='all') actives.push(filters.edad);
      if (filters.zona!=='all') actives.push(filters.zona);
      if (filters.persona!=='all') actives.push(filters.persona);
      $('#chip-filtros').textContent = actives.length? actives.join(' ¬∑ ') : 'Sin filtros';
    }
    function getFiltered(){
      const rangeNum = Math.min(30, Math.max(1, parseInt(filters.range,10) || 14));
      const start = 30 - rangeNum;
      const visits = ALL_VISITS.filter(v =>
        v.day>=start &&
        (filters.genero==='all' || v.gender===filters.genero) &&
        (filters.edad==='all' || v.age===filters.edad) &&
        (filters.zona==='all' || v.path.includes(filters.zona)) &&
        (filters.persona==='all' || v.persona===filters.persona)
      );
      const tickets = ALL_TICKETS.filter(t =>
        t.day>=start &&
        (filters.genero==='all' || t.gender===filters.genero) &&
        (filters.edad==='all' || t.age===filters.edad) &&
        (filters.zona==='all' || t.zone===filters.zona) &&
        (filters.persona==='all' || t.persona===filters.persona)
      );
      return { visits, tickets };
    }
    function sum(arr, sel){ return arr.reduce((s,x)=> s + (sel? sel(x): x), 0); }

    // ====== ECharts ======
    const chTrend   = echarts.init(document.getElementById('ch-trend'));
    const chMix     = echarts.init(document.getElementById('ch-mix-zone'));
    const chBubble  = echarts.init(document.getElementById('ch-bubble'));
    const chHeat    = echarts.init(document.getElementById('ch-heat'));
    const chCross   = echarts.init(document.getElementById('ch-cross'));
    const chHist    = echarts.init(document.getElementById('ch-hist'));
    const chCEI     = echarts.init(document.getElementById('ch-cei'));

    function wireLinks(f){
      const map = [
        ['lnk-bienvenida','Bienvenida.html'],
        ['lnk-dashboard','Dashboard.html'],
        ['lnk-recorridos','Recorridos.html'],
        ['lnk-buyer','Buyer.html'],
        ['lnk-staff','Staff.html'],
        ['lnk-comercial','Comercial.html'],
      ];
      map.forEach(([id,base])=>{ const a=document.getElementById(id); if (a) a.href=buildHref(base,f); });
    }

    function render(){
      updateFilterUI(); wireLinks(filters);

      const {visits, tickets} = getFiltered();

      // Ventana previa
      const prevStart = 30 - (Math.min(30, Math.max(1, parseInt(filters.range,10) || 14)) * 2);
      const prevVisits = ALL_VISITS.filter(v =>
        v.day>=prevStart && v.day < (30 - (parseInt(filters.range,10)||14)) &&
        (filters.genero==='all' || v.gender===filters.genero) &&
        (filters.edad==='all' || v.age===filters.edad) &&
        (filters.zona==='all' || v.path.includes(filters.zona)) &&
        (filters.persona==='all' || v.persona===filters.persona)
      );
      const prevTickets = ALL_TICKETS.filter(t =>
        t.day>=prevStart && t.day < (30 - (parseInt(filters.range,10)||14)) &&
        (filters.genero==='all' || t.gender===filters.genero) &&
        (filters.edad==='all' || t.age===filters.edad) &&
        (filters.zona==='all' || t.zone===filters.zona) &&
        (filters.persona==='all' || t.persona===filters.persona)
      );

      // KPIs
      const ventas = sum(tickets, t=>t.amount);
      const ventasPrev = Math.max(1, sum(prevTickets, t=>t.amount));
      const ticketsN = tickets.length;
      const ticketsPrev = Math.max(1, prevTickets.length);
      const atv = ventas / Math.max(1,ticketsN);
      const atvPrev = ventasPrev / ticketsPrev;

      const visitorsN = visits.length;
      const visitorsPrev = Math.max(1, prevVisits.length);
      const spv = ventas / Math.max(1, visitorsN);
      const spvPrev = ventasPrev / visitorsPrev;

      const upt = sum(tickets, t=>t.items) / Math.max(1, ticketsN);
      const uptPrev = sum(prevTickets, t=>t.items) / Math.max(1, ticketsPrev);

      // Yield por zona
      const zonesList = filters.zona==='all' ? zones.filter(z=>z!=='Caja') : [filters.zona];
      function yieldZona(z){
        const vZ = visits.filter(v=>v.path.includes(z));
        const tZ = tickets.filter(t=>t.zone===z);
        const ventasZ = sum(tZ, t=>t.amount);
        return ventasZ / Math.max(1, vZ.length);
      }
      const yields = zonesList.map(z=>yieldZona(z));
      const yieldAvg = yields.length ? (sum(yields)/yields.length) : 0;

      // CEI
      const dwellMean = (sum(visits, v=>v.dwell)/Math.max(1,visits.length));
      const denom = sum(visits, v=> v.dwell/Math.max(1,dwellMean));
      const cei = ventas / Math.max(1, denom);

      function varPct(curr, prev){ return ((curr - prev)/Math.max(1e-9, prev))*100; }
      const nf = new Intl.NumberFormat('es-CL');
      const clp = n => '$'+ nf.format(Math.round(n));
      function setK(idV, idVar, val, prev, isGoodUp=true, fmt=(x)=>x){
        const delta = varPct(val, prev).toFixed(1);
        document.getElementById(idV).textContent = fmt(val);
        const el = document.getElementById(idVar);
        const up = (isGoodUp? (val>=prev) : (val<=prev));
        el.textContent = (up? '‚ñ≤ ':'‚ñº ') + Math.abs(delta) + '%';
        el.className = 'delta ' + (up? 'up':'down');
      }
      setK('kpi-sales','kpi-sales-var', ventas, ventasPrev, true, clp);
      setK('kpi-tickets','kpi-tickets-var', ticketsN, ticketsPrev, true, x=>nf.format(x));
      setK('kpi-atv','kpi-atv-var', atv, atvPrev, true, clp);
      setK('kpi-upt','kpi-upt-var', upt, uptPrev, true, x=>x.toFixed(2));
      setK('kpi-visitors','kpi-visitors-var', visitorsN, visitorsPrev, true, x=>nf.format(x));
      setK('kpi-spv','kpi-spv-var', spv, spvPrev, true, clp);
      setK('kpi-yield','kpi-yield-var', yieldAvg, yieldAvg*0.95 + 1, true, clp);
      setK('kpi-cei','kpi-cei-var', cei, cei*0.94 + 1, true, clp);

      // Tendencia Ventas & SPV
      const rangeNum = Math.min(30, Math.max(1, parseInt(filters.range,10) || 14));
      const days = Array.from({length: rangeNum}, (_,i)=>30-rangeNum+i);
      const byDayTickets = d => tickets.filter(t=>t.day===d);
      const byDayVisits  = d => visits.filter(v=>v.day===d);
      const seriesSales = days.map(d => sum(byDayTickets(d), t=>t.amount));
      const seriesSPV = days.map(d => {
        const v = byDayVisits(d).length;
        const s = sum(byDayTickets(d), t=>t.amount);
        return s / Math.max(1, v);
      });
      chTrend.setOption({
        tooltip:{trigger:'axis', axisPointer:{type:'cross'},
          formatter:(p)=>{
            const s = p.find(x=>x.seriesName==='Ventas');
            const q = p.find(x=>x.seriesName==='SPV');
            return `${p[0].axisValueLabel}<br/>Ventas: <b>${clp(s? s.data:0)}</b><br/>SPV: <b>${clp(q? q.data:0)}</b>`;
          }},
        grid:{left:46,right:46,top:26,bottom:32},
        xAxis:{type:'category', data:days.map(d=>'D'+(d+1)), boundaryGap:false},
        yAxis:[{type:'value', name:'CLP'}, {type:'value', name:'CLP/visitante'}],
        dataZoom:[{type:'inside'},{type:'slider'}],
        series:[
          {name:'Ventas', type:'line', smooth:true, data:seriesSales, areaStyle:{} , yAxisIndex:0},
          {name:'SPV', type:'line', smooth:true, data:seriesSPV, yAxisIndex:1}
        ]
      });

      // Mix de ventas por zona (apilado por persona)
      const topZones = (() => {
        const zMap = new Map();
        for (const t of tickets){ zMap.set(t.zone, (zMap.get(t.zone)||0) + t.amount); }
        return Array.from(zMap.entries()).sort((a,b)=>b[1]-a[1]).filter(([z])=>z!=='Caja').slice(0,7).map(([z])=>z);
      })();
      const personasList = ["Solo","Pareja","Amigos","Familia"];
      const personaSeries = personasList.map(pe => ({
        name: pe, type:'bar', stack:'mix',
        data: topZones.map(z => sum(tickets.filter(t=>t.zone===z && t.persona===pe), t=>t.amount))
      }));
      chMix.setOption({
        tooltip:{trigger:'axis', formatter:(p)=>{
          const total = p.reduce((s,x)=>s+x.data,0);
          const lines = p.map(x => `${x.marker}${x.seriesName}: ${clp(x.data)} (${(x.data/Math.max(1,total)*100).toFixed(1)}%)`);
          return `${p[0].axisValue}<br/>Total: <b>${clp(total)}</b><br/>` + lines.join('<br/>');
        }},
        legend:{top:0},
        grid:{left:80,right:16,top:30,bottom:28},
        xAxis:{type:'category', data: topZones},
        yAxis:{type:'value'},
        series: personaSeries
      });
      chMix.off('click'); chMix.on('click', (p)=>{ if (p.componentType==='series'){ filters.zona = p.name; saveFilters(filters, true); render(); } });

      // Bubble UPT vs ATV por zona
      const zoneAgg = topZones.map(z=>{
        const tZ = tickets.filter(t=>t.zone===z);
        const ventasZ = sum(tZ, t=>t.amount);
        const atvZ = ventasZ/Math.max(1,tZ.length);
        const uptZ = sum(tZ, t=>t.items)/Math.max(1,tZ.length);
        return {z, atvZ, uptZ, ventasZ};
      });
      chBubble.setOption({
        tooltip:{formatter:(p)=> `${p.data.name}<br/>UPT: <b>${p.data.value[0].toFixed(2)}</b><br/>Ticket Promedio: <b>${clp(p.data.value[1])}</b><br/>Ventas: <b>${clp(p.data.value[2])}</b>`},
        grid:{left:46,right:18,top:20,bottom:36},
        xAxis:{name:'UPT', type:'value'},
        yAxis:{name:'Ticket Promedio (CLP)', type:'value'},
        series:[{
          type:'scatter',
          data: zoneAgg.map(o => ({name:o.z, value:[o.uptZ, o.atvZ, o.ventasZ], symbolSize: Math.max(12, Math.sqrt(o.ventasZ)/40)}))
        }]
      });

      // Heatmap ventas por hora √ó zona
      const hours = Array.from({length:12},(_,i)=>10+i);
      const heatData = [];
      for (let h of hours){
        for (let z of zones){
          const amt = sum(tickets.filter(t=>t.hour===h && t.zone===z), t=>t.amount);
          heatData.push([zones.indexOf(z), hours.indexOf(h), Math.round(amt)]);
        }
      }
      chHeat.setOption({
        tooltip:{formatter:(p)=> `${zones[p.value[0]]} ¬∑ ${hours[p.value[1]]}:00<br/><b>${clp(p.value[2])}</b>`},
        grid:{left:90,right:16,top:30,bottom:40},
        xAxis:{type:'category', data:zones, splitArea:{show:true}},
        yAxis:{type:'category', data:hours.map(h=>h+":00"), splitArea:{show:true}},
        visualMap:{min:0, max:Math.max(50000, Math.ceil(Math.max(...heatData.map(v=>v[2])))), calculable:true, orient:'horizontal', left:'center', bottom:0},
        series:[{type:'heatmap', data:heatData}]
      });
      chHeat.off('click'); chHeat.on('click', p => { const z = zones[p.value[0]]; if (z){ filters.zona=z; saveFilters(filters, true); render(); } });

      // Co-ocurrencia de categor√≠as
      function compress(path){ const out=[]; for(const z of path){ if(out[out.length-1]!==z) out.push(z); } return out; }
      const co = new Map();
      for (const t of tickets){
        const pth = compress(t.path.filter(z=>z!=='Caja'));
        const set = new Set(pth);
        const arr = Array.from(set);
        for (let i=0;i<arr.length;i++){
          for (let j=i+1;j<arr.length;j++){
            const a=arr[i], b=arr[j];
            const k1=a+'|'+b, k2=b+'|'+a;
            co.set(k1, (co.get(k1)||0)+1);
            co.set(k2, (co.get(k2)||0)+1);
          }
        }
      }
      const topForCross = zones.filter(z=>z!=='Caja');
      const idx = Object.fromEntries(topForCross.map((z,i)=>[z,i]));
      const crossSeries=[];
      for (const a of topForCross){
        for (const b of topForCross){
          const v = (a===b)? 0 : (co.get(a+'|'+b)||0);
          crossSeries.push([idx[a], idx[b], v]);
        }
      }
      chCross.setOption({
        tooltip:{formatter:(p)=> `${topForCross[p.value[0]]} ‚Üî ${topForCross[p.value[1]]}: <b>${p.value[2]}</b>`},
        grid:{left:90,right:16,top:40,bottom:40},
        xAxis:{type:'category', data:topForCross, axisLabel:{rotate:30}},
        yAxis:{type:'category', data:topForCross},
        visualMap:{min:0, max:Math.max(3, Math.ceil(Math.max(...crossSeries.map(v=>v[2])))), calculable:true, orient:'horizontal', left:'center', bottom:0},
        series:[{type:'heatmap', data:crossSeries}]
      });

      // Histograma tickets
      const amounts = tickets.map(t=>t.amount).sort((a,b)=>a-b);
      const minA = amounts.length? amounts[0]:0;
      const maxA = amounts.length? amounts[amounts.length-1]:1;
      const bins = 10;
      const step = Math.max(1, Math.ceil((maxA-minA)/bins));
      const hist = new Array(bins).fill(0);
      for (const a of amounts){ const i = Math.min(bins-1, Math.floor((a-minA)/step)); hist[i] ++; }
      function pctile(arr, p){
        if (!arr.length) return 0;
        const pos = (arr.length-1)*p; const lo=Math.floor(pos), hi=Math.ceil(pos);
        if (lo===hi) return arr[lo];
        return arr[lo] + (arr[hi]-arr[lo])*(pos-lo);
      }
      const p25 = pctile(amounts, .25), p50=pctile(amounts,.5), p75=pctile(amounts,.75);
      chHist.setOption({
        tooltip:{trigger:'axis', formatter:(p)=> {
          const i = p[0].dataIndex; const l=minA + i*step; const r=l+step-1;
          return `${clp(l)} ‚Äì ${clp(r)}: <b>${p[0].data}</b>`;
        }},
        grid:{left:46,right:16,top:20,bottom:28},
        xAxis:{type:'category', data: Array.from({length:bins},(_,i)=> `${clp(minA+i*step)}‚Äì${clp(minA+(i+1)*step-1)}`)},
        yAxis:{type:'value'},
        series:[{type:'bar', data:hist,
          markLine:{symbol:'none', data:[
            {xAxis: Math.max(0, Math.floor((p25-minA)/step)), label:{formatter:'P25'}},
            {xAxis: Math.max(0, Math.floor((p50-minA)/step)), label:{formatter:'P50'}},
            {xAxis: Math.max(0, Math.floor((p75-minA)/step)), label:{formatter:'P75'}},
          ]}
        }]
      });

      // Ranking CEI por zona
      const ceiByZone = zones.filter(z=>z!=='Caja').map(z=>{
        const vZ = visits.filter(v=>v.path.includes(z));
        const tZ = tickets.filter(t=>t.zone===z);
        const ventasZ = sum(tZ, t=>t.amount);
        const dwellMeanLocal = (sum(visits, v=>v.dwell)/Math.max(1,visits.length));
        const denomZ = sum(vZ, v=> v.dwell / Math.max(1, dwellMeanLocal));
        const ceiZ = ventasZ / Math.max(1, denomZ);
        return {z, ceiZ, spvZ: ventasZ / Math.max(1, vZ.length)};
      }).sort((a,b)=>b.ceiZ - a.ceiZ);
      chCEI.setOption({
        tooltip:{formatter:(p)=> {
          const obj = ceiByZone.find(x=>x.z===p.name) || {spvZ:0};
          return `${p.name}<br/>CEI: <b>${clp(p.data)}</b><br/>SPV: <b>${clp(obj.spvZ)}</b>`;
        }},
        grid:{left:120,right:16,top:20,bottom:28},
        xAxis:{type:'value'},
        yAxis:{type:'category', data: ceiByZone.map(o=>o.z)},
        series:[{type:'bar', data: ceiByZone.map(o=>o.ceiZ), label:{show:true, position:'right', formatter:(p)=> clp(p.value)} }]
      });

      // Insights
      const insights = [];
      if (ceiByZone[0]) insights.push(`La zona con mejor CEI es <b>${ceiByZone[0].z}</b> (${clp(ceiByZone[0].ceiZ)}).`);
      insights.push(`El <b>SPV</b> es <b>${clp(spv)}</b> (${varPct(spv, spvPrev)>=0? '‚ñ≤':''}${Math.abs(varPct(spv, spvPrev)).toFixed(1)}% vs periodo previo).`);
      const byHour = Array.from({length:12},(_,i)=>10+i).map(h=>({h, amt: sum(tickets.filter(t=>t.hour===h), t=>t.amount)}));
      const bestHour = byHour.reduce((a,b)=> b.amt>a.amt? b:a, {h:'‚Äì',amt:0});
      if (bestHour.amt>0) insights.push(`La franja de mayor venta es <b>${bestHour.h}:00</b> con <b>${clp(bestHour.amt)}</b>.`);
      const zoneAgg2 = topZones.map(z=>{
        const tZ = tickets.filter(t=>t.zone===z);
        const ventasZ = sum(tZ, t=>t.amount), atvZ = ventasZ/Math.max(1,tZ.length), uptZ = sum(tZ, t=>t.items)/Math.max(1,tZ.length);
        return {z, score: uptZ*atvZ, uptZ, atvZ};
      }).sort((a,b)=>b.score-a.score)[0];
      if (zoneAgg2) insights.push(`Oportunidad: <b>${zoneAgg2.z}</b> combina Art. x Ticket <b>${zoneAgg2.uptZ.toFixed(2)}</b> y Ticket promedio <b>${clp(zoneAgg2.atvZ)}</b>.`);
      document.getElementById('insights-list').innerHTML = insights.map(x=>`<li>${x}</li>`).join('');
    }

    // ===== Export CSV =====
    function exportCSV(){
      const {visits, tickets} = getFiltered();
      const dwellMean = (sum(visits, v=>v.dwell)/Math.max(1, visits.length));
      const spv = sum(tickets, t=>t.amount) / Math.max(1, visits.length);

      const byVisitKey = new Map();
      for (const v of visits){
        const key = `${v.day}|${v.hour}|${v.gender}|${v.age}|${v.persona}`;
        const cur = byVisitKey.get(key);
        if (!cur || v.dwell>cur) byVisitKey.set(key, v.dwell);
      }

      const rows = tickets.map(t=>{
        const key = `${t.day}|${t.hour}|${t.gender}|${t.age}|${t.persona}`;
        const dwell = byVisitKey.get(key) || dwellMean;
        const cei_factor = dwell / Math.max(1, dwellMean);
        return {
          day: t.day+1, hour:t.hour, gender:t.gender, age:t.age, persona:t.persona,
          zone:t.zone, items:t.items, amount:t.amount, avgItemPrice:t.avgItemPrice,
          spv_at_visit: Math.round(spv), cei_factor: +(cei_factor.toFixed(3))
        };
      });

      const header = Object.keys(rows[0]||{
        day:'',hour:'',gender:'',age:'',persona:'',zone:'',items:'',amount:'',avgItemPrice:'',spv_at_visit:'',cei_factor:''
      }).join(',');
      const body = rows.map(r=> Object.values(r).join(',')).join('\n');
      const blob = new Blob([header+'\n'+body], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='comercial_dataset_filtrado.csv'; a.click(); URL.revokeObjectURL(url);
    }

    // ===== Drawer & resize =====
    const sidebar = document.getElementById('sidebar');
    const openBtn = document.getElementById('openNav');
    const closeBtn = document.getElementById('closeNav');
    const filtersDetails = document.getElementById('filters');
    const isMobile = () => window.matchMedia('(max-width:900px)').matches;
    const charts = [chTrend,chMix,chBubble,chHeat,chCross,chHist,chCEI];
    const forceResize = () => charts.forEach(c=>c.resize());
    const openSidebar = safe(()=> { sidebar.classList.add('open'); setTimeout(forceResize, 60); });
    const closeSidebar = safe(()=> { sidebar.classList.remove('open'); setTimeout(forceResize, 60); });

    // ===== Eventos =====
    window.addEventListener('DOMContentLoaded', safe(()=>{
      // al iniciar, garantizamos filtros v√°lidos escritos en URL y storage
      saveFilters(filters, true);
      wireLinks(filters); updateFilterUI();

      ['click','touchstart'].forEach(ev=>{
        openBtn?.addEventListener(ev, openSidebar, {passive:true});
        closeBtn?.addEventListener(ev, closeSidebar, {passive:true});
      });
      document.addEventListener('click', safe((e)=>{
        if (!isMobile()) return;
        if (sidebar.classList.contains('open') && !sidebar.contains(e.target) && !openBtn.contains(e.target)) {
          sidebar.classList.remove('open'); setTimeout(forceResize, 60);
        }
      }), {passive:true});
      filtersDetails.addEventListener('toggle', safe(()=> setTimeout(forceResize, 60)));
      window.addEventListener('resize', safe(()=> setTimeout(forceResize, 30)));

      ["f-fecha","f-genero","f-edad","f-zona","f-persona"].forEach(id=>{
        document.getElementById(id).addEventListener('change', safe(()=>{
          filters.range = +document.getElementById("f-fecha").value;
          filters.genero = document.getElementById("f-genero").value;
          filters.edad = document.getElementById("f-edad").value;
          filters.zona = document.getElementById("f-zona").value;
          filters.persona = document.getElementById("f-persona").value;
          saveFilters(filters, true);
          render(); setTimeout(forceResize, 20);
        }));
      });

      document.getElementById('btn-export').addEventListener('click', safe(exportCSV));

      // Render inicial
      requestAnimationFrame(safe(()=>{ render(); setTimeout(forceResize, 60); }));
    }));
  })();
  </script>
</body>
</html>
