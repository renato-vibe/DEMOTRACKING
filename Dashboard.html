<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>FollowUP – Dashboard</title>
  <link rel="icon" href="https://media.licdn.com/dms/image/v2/D4E0BAQFvVz5clxj08w/company-logo_200_200/B4EZXyyjtSG0AI-/0/1743535094994/followupcx_logo?e=2147483647&v=beta&t=FVh7RUdEGOzXdcCx5TXmlVWeh3MfenVzm9HDifB-B0k" type="image/png">
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>

  <style>
    :root{
      /* colores base + layout (igual a “Bienvenida”) */
      --brand:#0f6eea; --brand-600:#0a55b6;
      --ink:#0f172a; --muted:#637488;
      --ok:#16a34a; --warn:#ef4444;
      --bg:#f5f7fb; --card:#ffffff; --chip:#e6eefc;
      --radius:14px; --shadow:0 6px 24px rgba(15,23,42,.06);
      --sidebar-w:264px; --sidebar-mini:64px; --topbar-h:56px;
      --nav-item-h:38px; --nav-pad:12px; --divider:#e5e7eb;
      --primary-600:#0b5f80; --focus:#93c5fd;

      /* dashboard */
      --kpi-gap:16px;

      /* drawer de filtros */
      --filter-w:420px;
      --filter-accent:#0b5f80;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
      color:var(--ink); background:var(--bg); display:flex;
    }

    /* ===== Shell & offsets (sidebar izquierda) ===== */
    body.sb-mini .shell{ margin-left: var(--sidebar-mini); }
    body.sb-wide .shell{ margin-left: var(--sidebar-w); }
    .shell{display:flex; width:100%; min-height:100svh; overflow:hidden; transition:margin-left .2s ease;}
    .main{flex:1; display:flex; flex-direction:column; min-width:0;}
    .page{flex:1; overflow:auto; overflow-x:hidden; padding:18px; min-width:0;}

    /* ===== Topbar móvil (blanca, como “Bienvenida”) ===== */
    .topbar{
      display:none; position:sticky; top:0; z-index:60; height:var(--topbar-h);
      background:#fff; color:#0b2238; padding:0 12px; align-items:center; gap:8px; border-bottom:1px solid #eaeff5;
    }
    .topbar h1{font-size:16px; margin:0; font-weight:800}
    .hamb{appearance:none;border:0;background:transparent;color:#0b2238;font-size:22px;line-height:1; padding:8px 10px; border-radius:10px; cursor:pointer}
    .hamb:active{transform:scale(.98)}

    /* ===== Sidebar izquierda (idéntica a “Bienvenida”) ===== */
    .sidebar{
      width:var(--sidebar-w); min-width:var(--sidebar-w);
      background:#fff; color:var(--ink); padding:0; display:flex; flex-direction:column;
      border-right:1px solid var(--divider);
      position:fixed; inset:0 auto 0 0; z-index:70;
      transform:translateX(0); transition:transform .25s ease, width .2s ease, min-width .2s ease;
    }
    .sidebar.mini{ width:var(--sidebar-mini); min-width:var(--sidebar-mini);}
    .sidebar.mini.hovering{ width:var(--sidebar-w); min-width:var(--sidebar-w); }
    .sidebar .brand{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px var(--nav-pad); height:var(--topbar-h); border-bottom:1px solid var(--divider);
      font-weight:800; letter-spacing:.2px;
    }
    .brand .logo{display:flex; align-items:center; gap:10px}
    .brand .logo svg{width:32px; height:32px}
    .nav{padding:10px; display:flex; flex-direction:column; gap:6px; overflow:auto}
    .nav ul{list-style:none; margin:0; padding:0}
    .nav .item{
      display:flex; align-items:center; gap:8px; height:var(--nav-item-h);
      padding:0 6px; border-radius:10px; cursor:pointer; text-decoration:none; color:#0f172a;
      transition:background-color .15s ease, color .15s ease;
    }
    .nav .item:hover{ background:#f8fafc }
    .nav .item[aria-current="page"], .nav .item.active{ background:var(--primary-600); color:#fff; }
    .nav .icon{width:38px; display:flex; align-items:center; justify-content:center; flex:0 0 38px; color:#0b2238}
    .nav .label{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .mini .label{display:none}
    .mini.hovering .label{display:inline}
    .divider{border:0; border-top:1px solid var(--divider); margin:8px 0}

    /* Colapsable */
    .collapse .collapse-head{ display:flex; align-items:center; gap:8px; height:var(--nav-item-h); padding:0 6px; border-radius:10px; cursor:pointer; user-select:none; }
    .collapse .chev{margin-left:auto; transition:transform .15s ease}
    .collapse[aria-expanded="true"] .chev{transform:rotate(-90deg)}
    .collapse .panel{display:none; padding-left:6px}
    .collapse[aria-expanded="true"] .panel{display:block}
    .mini .collapse .chev, .mini .panel{display:none}
    .mini.hovering .collapse .chev{display:inline}

    /* Overlay general (para sidebar izq en móvil) */
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); opacity:0; pointer-events:none; transition:opacity .2s ease; z-index:60; }
    .overlay.visible{opacity:1; pointer-events:auto}

    /* ===== Botonera superior (fecha + filtros) ===== */
    .actions{display:flex; gap:10px; align-items:center; margin-bottom:14px; flex-wrap:wrap}
    .datefake{
      display:flex; align-items:center; gap:10px; padding:10px 12px; background:#fff; border:1px solid #e7ecf7; border-radius:12px; min-height:40px;
      box-shadow:var(--shadow); color:#0b2238;
    }
    .btn{
      appearance:none; border:0; border-radius:12px; min-height:40px; padding:10px 14px; font-weight:700; cursor:pointer;
    }
    .btn.filter{
      background:var(--primary-600); color:#fff; box-shadow:0 6px 18px rgba(11,95,128,.25);
    }
    .btn.filter:active{transform:scale(.98)}

    /* ===== Drawer de Filtros (derecha) ===== */
    .filter-overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.45);
      opacity:0; pointer-events:none; transition:opacity .2s ease; z-index:84;
    }
    .filter-overlay.visible{opacity:1; pointer-events:auto}
    .filter-drawer{
      position:fixed; top:0; right:0; bottom:0; width:var(--filter-w); max-width:100vw; background:#fff; z-index:85;
      transform:translateX(100%); transition:transform .25s ease; display:flex; flex-direction:column;
      border-left:1px solid #e5e7eb; box-shadow:-24px 0 48px rgba(4,14,46,.14); border-top-left-radius:14px; border-bottom-left-radius:14px;
    }
    .filter-drawer.open{transform:translateX(0)}
    .filter-head{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:16px 18px; border-bottom:1px solid #eaeef4}
    .filter-head h3{margin:0; font-size:20px}
    .x{appearance:none;border:0;background:#f3f4f6; width:32px; height:32px; border-radius:10px; cursor:pointer; font-size:18px}

    .filter-scroll{flex:1; overflow:auto; padding-bottom:12px}
    .exp{border-bottom:1px solid #edf0f6}
    .exp summary{
      list-style:none; cursor:pointer; padding:16px 18px; font-weight:700; color:#0b2238; display:flex; align-items:center; justify-content:space-between;
    }
    .exp summary::-webkit-details-marker{display:none}
    .exp[open] summary{background:#fbfcff}
    .exp .exp-body{padding:0 18px 16px 18px}
    .field{display:flex; flex-direction:column; gap:6px; margin-top:10px}
    label{font-size:12px; color:var(--muted)}
    select{appearance:none; width:100%; padding:12px 12px; border-radius:10px; background:#fff; border:1px solid #e7ecf7; outline:none; color:var(--ink); font-size:14px; min-height:40px;}
    .two-grid{display:grid; gap:10px; grid-template-columns:repeat(2,1fr)}
    .filter-actions{
      position:sticky; bottom:0; background:#fff; border-top:1px solid #eaeef4; padding:12px; display:flex; justify-content:space-between; gap:12px;
    }
    .btn.ghost{background:#fff; color:#0b2238; border:1px solid #e2e8f0}
    .btn.apply{background:#0b5f80; color:#fff}

    /* ===== Tarjetas / dashboard ===== */
    .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; width:100%; max-width:100%}
    .pill{background:#f1f5ff;border:1px solid #e3ecff;color:#173f82;border-radius:999px;padding:6px 10px;font-size:12px}
    .card.title{display:flex; align-items:center; justify-content:space-between; padding:18px; gap:12px}
    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{background:var(--chip); color:#17438a; padding:6px 10px; border-radius:999px; font-size:12px}
    .chip.reset{cursor:pointer}

    .kpis{ display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: var(--kpi-gap); grid-auto-rows: minmax(120px, auto); align-items: stretch; }
    .kpi{ padding:18px 18px 14px; border:1px solid #e7ecf7; border-radius:18px; box-shadow:0 10px 30px rgba(15,23,42,.08); container-type:inline-size; min-width:0; }
    .kpi h4{ margin:0 0 8px; font-size:14px; color:#4b5870; letter-spacing:.2px; }
    .kpi .v{ font-size: clamp(22px, 12cqw, 42px); line-height:1; font-weight:900; letter-spacing:.2px; color:#111827; margin-bottom:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .delta{ display:inline-flex; align-items:center; gap:6px; font-size:13px; font-weight:600; }
    .delta.up{ color:#16a34a; } .delta.down{ color:#ef4444; }

    .section{margin-top:16px; display:grid; gap:14px; grid-template-columns:repeat(12,1fr)}
    .span-12{grid-column:span 12}.span-8{grid-column:span 8}.span-6{grid-column:span 6}.span-4{grid-column:span 4}
    @media (max-width:1200px){ .span-8,.span-6,.span-4{grid-column:span 12} }

    .chart{width:100%; max-width:100%; min-height:320px; height:clamp(300px, 48vh, 420px)}
    .chart.tall{min-height:420px; height:clamp(380px, 56vh, 520px)}
    .muted{color:var(--muted)}

    /* ===== Responsive ===== */
    @media (max-width: 900px){
      .topbar{display:flex}
      .shell{ margin-left:0; }
      .sidebar{ width:100vw; min-width:100vw; transform:translateX(-100%); }
      .sidebar.open{ transform:translateX(0) }
      .page{padding:14px}
      .sidebar.mini,.sidebar.mini.hovering{ width:100vw; min-width:100vw; }
      .mini .label{display:inline}
      .mini .collapse .chev{display:inline}

      /* Drawer filtros: fullscreen en mobile */
      .filter-drawer{ width:100vw; border-radius:0 }
    }
    @media (min-width:901px){
      /* ocultamos summary del viejo details (ya no se usa) */
    }

    /* Accesibilidad */
    .item:focus,.collapse-head:focus,.btn:focus,.x:focus,summary:focus{outline:2px solid var(--focus); outline-offset:2px; border-radius:10px}
    @media (prefers-reduced-motion: reduce){ *{animation:none!important; transition:none!important} }
  </style>
</head>
<body class="sb-mini">
  <div class="shell" id="shell">
    <!-- Overlay general (sidebar izquierda móvil) -->
    <div class="overlay" id="overlay" aria-hidden="true"></div>


<!-- HEAD: fuente de Material Symbols + ajustes -->
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght@400;500;600&display=swap" rel="stylesheet">
<style>
 /* Material Symbols: base */
.material-symbols-rounded{
  font-variation-settings: 'FILL' 0, 'wght' 500, 'GRAD' 0, 'opsz' 24;
  font-size:22px; line-height:1;
  display:inline-flex; align-items:center; justify-content:center;
}

/* Ítem activo: fondo y texto blancos (ya lo tienes) + icono blanco */
.nav .item[aria-current="page"],
.nav .item.active{
  background:var(--primary-600);
  color:#fff;
}
.nav .item[aria-current="page"] .icon,
.nav .item.active .icon,
.nav .item[aria-current="page"] .material-symbols-rounded,
.nav .item.active .material-symbols-rounded{
  color:#fff;
}

/* ===== Solo DESKTOP (>=901px): mini colapsada muestra sólo ícono centrado ===== */
@media (min-width:901px){
  .sidebar.mini:not(.hovering) .nav .item{
    display:flex; align-items:center; justify-content:center;
    width:48px; height:48px; padding:0;
  }
  .sidebar.mini:not(.hovering) .nav .item .label{ display:none; }
}

/* ===== Solo MÓVIL (<=900px): drawer fullscreen con ícono + texto ===== */
@media (max-width:900px){
  .sidebar{ width:100vw; min-width:100vw; transform:translateX(-100%); }
  .sidebar.open{ transform:translateX(0); }
  .sidebar.mini .nav .item{
    display:flex; align-items:center; justify-content:flex-start;
    gap:10px; width:auto; height:var(--nav-item-h); padding:0 6px;
  }
  .sidebar.mini .nav .item .label{ display:inline; }
}

</style>

<!-- ===== Sidebar izquierda / Drawer ===== -->
<aside class="sidebar mini" id="sidebar" role="navigation" aria-label="Módulos de reportes">
  <div class="brand">
    <div class="logo" aria-label="FollowUP">
      <svg viewBox="0 0 48 48" aria-hidden="true">
        <defs>
          <linearGradient id="g" x1="0" x2="1">
            <stop offset="0" stop-color="#0f6eea"/>
            <stop offset="1" stop-color="#0a55b6"/>
          </linearGradient>
        </defs>
        <circle cx="24" cy="24" r="20" fill="url(#g)"/>
        <path d="M14 26l6 6 14-14" stroke="#fff" stroke-width="3" fill="none" stroke-linecap="round"/>
      </svg>
      <strong class="label">FollowUP Reports</strong>
    </div>
  </div>

  <nav class="nav">
    <ul>
      <li>
        <a id="lnk-bienvenida" class="item" href="https://home.fupbi.org/">
          <span class="icon material-symbols-rounded" aria-hidden="true">home</span>
          <span class="label">Inicio</span>
        </a>
      </li>

      <li class="collapse" id="grp-reportes" aria-expanded="true">
        <div class="collapse-head" role="button" tabindex="0" aria-controls="panel-reportes" aria-expanded="true">
          <span class="icon material-symbols-rounded" aria-hidden="true">folder_open</span>
          <span class="label">Reportes</span>
          <span class="chev material-symbols-rounded" aria-hidden="true">expand_more</span>
        </div>
        <div id="panel-reportes" class="panel" role="region" aria-label="Reportes">
          <ul>
            <li>
              <a class="item" id="lnk-dashboard" href="Dashboard.html" aria-current="page">
                <span class="icon material-symbols-rounded" aria-hidden="true">space_dashboard</span>
                <span class="label">Dashboard</span>
              </a>
            </li>
            <li>
              <a class="item" id="lnk-recorridos" href="Recorridos.html">
                <span class="icon material-symbols-rounded" aria-hidden="true">map</span>
                <span class="label">Recorridos</span>
              </a>
            </li>
            <li>
              <a class="item" id="lnk-buyer" href="Buyer.html">
                <span class="icon material-symbols-rounded" aria-hidden="true">group</span>
                <span class="label">Buyer Persona</span>
              </a>
            </li>
            <li>
              <a class="item" id="lnk-staff" href="Staff.html">
                <span class="icon material-symbols-rounded" aria-hidden="true">person</span>
                <span class="label">Staff</span>
              </a>
            </li>
            <li>
              <a class="item" id="lnk-comercial" href="Comercial.html">
                <span class="icon material-symbols-rounded" aria-hidden="true">trending_up</span>
                <span class="label">Comercial</span>
              </a>
            </li>
          </ul>
        </div>
      </li>
    </ul>
  </nav>
  <div style="margin:auto 10px 10px; opacity:.85; font-size:12px;">
    <small>Aquí va tu marca</small>
  </div>
</aside>

    <!-- ===== Main ===== -->
    <div class="main">
      <div class="topbar">
        <button class="hamb" id="openNav" aria-label="Abrir menú">☰</button>
        <h1 id="pageTitle">Dashboard</h1>
      </div>

      <main class="page">
        <!-- Fila de acciones (fecha + botón Filtros) -->
        <div class="actions">
          <div class="datefake" title="Rango de fechas">
            <span>📅</span><span id="date-range-label">17/02/2025 - 23/02/2025</span>
          </div>
          <button
  class="btn filter"
  id="btn-open-filters"
  aria-label="Abrir filtros"
  style="margin-left:auto; display:inline-flex; align-items:center; gap:8px;"
>
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3" style="flex:0 0 auto;">
    <path d="M400-240v-80h160v80H400ZM240-440v-80h480v80H240ZM120-640v-80h720v80H120Z"/>
  </svg>
  <span style="line-height:1">Filtros</span>
</button>

        </div>

        <!-- Título -->
        <div class="card title" style="margin-bottom:16px;">
          <h2 style="margin:0">Dashboard ejecutivo</h2>
          <span class="pill">Tráfico, permanencia, zonas y conversión a Caja</span>
        </div>

        <!-- Insights -->
        <div class="card" id="insights-card" style="margin-bottom:16px;">
          <h3 style="margin:0 0 8px">Insights automáticos</h3>
          <ul id="insights-list" class="muted" style="margin:0 0 6px 18px"></ul>
        </div>

        <!-- KPIs -->
        <div class="kpis" role="region" aria-label="Indicadores Clave">
          <div class="card kpi"><h4>Tráfico Total</h4><div class="v" id="kpi-trafico">–</div><div class="delta up" id="kpi-trafico-var">–</div></div>
          <div class="card kpi"><h4>Visitantes Únicos</h4><div class="v" id="kpi-unicos">–</div><div class="delta up" id="kpi-unicos-var">–</div></div>
          <div class="card kpi"><h4>Tiempo Promedio en Tienda</h4><div class="v" id="kpi-permanencia">–</div><div class="delta down" id="kpi-permanencia-var">–</div></div>
          <div class="card kpi"><h4>Zonas Visitadas por Visita</h4><div class="v" id="kpi-zonas">–</div><div class="delta up" id="kpi-zonas-var">–</div></div>
          <div class="card kpi"><h4>Conversión a Caja</h4><div class="v" id="kpi-conv-caja">–</div><div class="delta up" id="kpi-conv-caja-var">–</div></div>
          <div class="card kpi"><h4>Hora Pico</h4><div class="v" id="kpi-peak-hour">–</div><div class="delta up" id="kpi-peak-hour-note">–</div></div>
          <div class="card kpi"><h4>Bounce (≤2 zonas)</h4><div class="v" id="kpi-bounce">–</div><div class="delta down" id="kpi-bounce-var">–</div></div>
          <div class="card kpi"><h4>Recirculación</h4><div class="v" id="kpi-recir">–</div><div class="delta up" id="kpi-recir-var">–</div></div>
        </div>

        <div class="section">
          <div class="card span-8"><h3 style="margin:0 0 10px">Tendencia de tráfico</h3><div id="ch-trafico-line" class="chart"></div></div>
          <div class="card span-4"><h3 style="margin:0 0 10px">Zonas más visitadas</h3><p class="muted" style="margin:0 0 6px">Click en una barra para filtrar por zona.</p><div id="ch-zonas-bar" class="chart"></div></div>
          <div class="card span-12"><h3 style="margin:0 0 10px">Ocupación por hora × zona (minutos estimados)</h3><div id="ch-heat-ocup" class="chart tall"></div></div>
          <div class="card span-6"><h3 style="margin:0 0 10px">Distribución por género</h3><div id="ch-genero-pie" class="chart"></div></div>
          <div class="card span-6"><h3 style="margin:0 0 10px">Distribución por rango etario</h3><div id="ch-edad-pie" class="chart"></div></div>
          <div class="card span-6"><h3 style="margin:0 0 10px">Histograma de permanencia</h3><div id="ch-dwell-hist" class="chart"></div></div>
          <div class="card span-6"><h3 style="margin:0 0 10px">Embudo de movimiento hasta Caja</h3><div id="ch-funnel" class="chart"></div></div>
        </div>
      </main>
    </div>
  </div>

  <!-- ===== Drawer de Filtros (derecha) ===== -->
  <div class="filter-overlay" id="filterOverlay" aria-hidden="true"></div>
  <aside class="filter-drawer" id="filterDrawer" role="dialog" aria-modal="true" aria-label="Filtros">
    <div class="filter-head">
      <h3>Filtros</h3>
      <button class="x" id="btn-close-filters" aria-label="Cerrar">✕</button>
    </div>
    <div class="filter-scroll">
      <!-- 1) Rango de fechas -->
      <details class="exp" open>
        <summary>Rango de fechas ▾</summary>
        <div class="exp-body">
          <div class="field">
            <label for="f-fecha">Seleccionar</label>
            <select id="f-fecha">
              <option value="7">Últimos 7 días</option>
              <option value="14" selected>Últimos 14 días</option>
              <option value="30">Últimos 30 días</option>
            </select>
          </div>
        </div>
      </details>

      <!-- 2) Género -->
      <details class="exp">
        <summary>Género ▾</summary>
        <div class="exp-body">
          <div class="field">
            <label for="f-genero">Filtrar por</label>
            <select id="f-genero">
              <option value="all" selected>Todos</option>
              <option value="Femenino">Femenino</option>
              <option value="Masculino">Masculino</option>
            </select>
          </div>
        </div>
      </details>

      <!-- 3) Rango etario -->
      <details class="exp">
        <summary>Rango etario ▾</summary>
        <div class="exp-body">
          <div class="field">
            <label for="f-edad">Filtrar por</label>
            <select id="f-edad">
              <option value="all" selected>Todos</option>
              <option value="Niño">Niño</option>
              <option value="Adulto Joven">Adulto Joven</option>
              <option value="Adulto">Adulto</option>
              <option value="Senior">Senior</option>
            </select>
          </div>
        </div>
      </details>

      <!-- 4) Zona -->
      <details class="exp">
        <summary>Zonas ▾</summary>
        <div class="exp-body">
          <div class="field">
            <label for="f-zona">Filtrar por</label>
            <select id="f-zona">
              <option value="all" selected>Todas</option>
              <option>Pasillo</option><option>Vitrina</option><option>Tienda</option>
              <option>Perfumería</option><option>Zapatería</option><option>Joyería</option>
              <option>Carteras</option><option>Tane</option><option>Caja</option>
            </select>
          </div>
        </div>
      </details>

      <!-- 5) Tipo de grupo -->
      <details class="exp">
        <summary>Tipo de grupo ▾</summary>
        <div class="exp-body">
          <div class="field">
            <label for="f-persona">Filtrar por</label>
            <select id="f-persona">
              <option value="all" selected>Todos</option>
              <option value="Solo">Solo</option>
              <option value="Pareja">Pareja</option>
              <option value="Amigos">Amigos</option>
              <option value="Familia">Familia</option>
            </select>
          </div>
        </div>
      </details>
    </div>
    <div class="filter-actions">
      <button class="btn ghost" id="btn-reset">Restablecer filtros</button>
      <button class="btn apply" id="btn-apply">Aplicar</button>
    </div>
  </aside>

  <script>
  (function () {
    const safe = fn => (...args) => { try { return fn(...args); } catch(e){ console.error(e); } };

    /* =========================================================
       NAV / DRAWER IZQUIERDO (idéntico a “Bienvenida”)
       ========================================================= */
    let forceResizeSoon = () => {}; // se redefine más abajo

    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const openBtn = document.getElementById('openNav');
    const pageTitle = document.getElementById('pageTitle');
    const isMobile = () => window.matchMedia('(max-width:900px)').matches;

    function applyBodyOffset(){
      if (isMobile()) {
        document.body.classList.remove('sb-mini','sb-wide');
      } else {
        if (sidebar.classList.contains('mini') && !sidebar.classList.contains('hovering')) {
          document.body.classList.add('sb-mini'); document.body.classList.remove('sb-wide');
        } else {
          document.body.classList.add('sb-wide'); document.body.classList.remove('sb-mini');
        }
      }
    }
    applyBodyOffset();
    window.addEventListener('resize', safe(() => { applyBodyOffset(); forceResizeSoon(); }));

    function openSidebar(){ sidebar.classList.add('open'); overlay.classList.add('visible'); document.body.style.overflow='hidden'; forceResizeSoon(); }
    function closeSidebar(){ sidebar.classList.remove('open'); overlay.classList.remove('visible'); document.body.style.overflow=''; forceResizeSoon(); }

    ;['click','touchstart'].forEach(ev=>{
      openBtn?.addEventListener(ev, safe(openSidebar), {passive:true});
      overlay?.addEventListener(ev, safe(closeSidebar), {passive:true});
    });

    document.addEventListener('keydown', safe(e=>{
      if(e.key==='Escape' && isMobile() && overlay.classList.contains('visible')) closeSidebar();
    }));

    sidebar.addEventListener('mouseenter', safe(()=>{
      if(!isMobile() && sidebar.classList.contains('mini')){
        sidebar.classList.add('hovering'); applyBodyOffset(); forceResizeSoon();
      }
    }));
    sidebar.addEventListener('mouseleave', safe(()=>{
      if(!isMobile()){
        sidebar.classList.remove('hovering'); applyBodyOffset(); forceResizeSoon();
      }
    }));

    const reportes = document.getElementById('grp-reportes');
    const head = reportes.querySelector('.collapse-head');
    function setCollapse(open){ reportes.setAttribute('aria-expanded', String(open)); head.setAttribute('aria-expanded', String(open)); }
    head.addEventListener('click', safe(()=>{
      if (sidebar.classList.contains('mini') && !sidebar.classList.contains('hovering') && !isMobile()) return;
      setCollapse(reportes.getAttribute('aria-expanded')!=='true');
    }));
    head.addEventListener('keydown', safe(e=>{
      if(e.key==='Enter' || e.key===' '){
        e.preventDefault();
        if (sidebar.classList.contains('mini') && !sidebar.classList.contains('hovering') && !isMobile()) return;
        setCollapse(reportes.getAttribute('aria-expanded')!=='true');
      }
    }));

    (function markActive(){
      const path = location.pathname.split('/').pop() || 'Dashboard.html';
      document.querySelectorAll('.nav a.item').forEach(a=>{
        a.removeAttribute('aria-current'); a.classList.remove('active');
        const file = (a.getAttribute('href')||'').split('?')[0].split('/').pop();
        if(file === path){ a.setAttribute('aria-current','page'); a.classList.add('active'); }
      });
      const current = document.querySelector('.nav a.item[aria-current="page"] .label');
      if (current && pageTitle){ pageTitle.textContent = current.textContent.trim(); }
    })();

    document.addEventListener('click', safe((e)=>{
      if (!isMobile()) return;
      if (overlay.classList.contains('visible') && !sidebar.contains(e.target) && e.target!==openBtn && !openBtn.contains?.(e.target)) {
        closeSidebar();
      }
    }), {passive:true});

    /* =========================================================
       DRAWER DE FILTROS (derecha)
       ========================================================= */
    const fOverlay = document.getElementById('filterOverlay');
    const fDrawer  = document.getElementById('filterDrawer');
    const openFiltersBtn  = document.getElementById('btn-open-filters');
    const closeFiltersBtn = document.getElementById('btn-close-filters');
    const applyBtn  = document.getElementById('btn-apply');
    const resetBtn  = document.getElementById('btn-reset');

    function openFilters(){ fOverlay.classList.add('visible'); fDrawer.classList.add('open'); document.body.style.overflow='hidden'; }
    function closeFilters(){ fOverlay.classList.remove('visible'); fDrawer.classList.remove('open'); document.body.style.overflow=''; forceResizeSoon(); }

    ;['click','touchstart'].forEach(ev=>{
      openFiltersBtn?.addEventListener(ev, safe(openFilters), {passive:true});
      fOverlay?.addEventListener(ev, safe(closeFilters), {passive:true});
      closeFiltersBtn?.addEventListener(ev, safe(closeFilters), {passive:true});
    });
    document.addEventListener('keydown', safe(e=>{
      if(e.key==='Escape' && fOverlay.classList.contains('visible')) closeFilters();
    }));

    /* =========================================================
       DASHBOARD (datos + charts + filtros funcionales)
       ========================================================= */
    window.addEventListener('DOMContentLoaded', safe(() => {
      const rand = (seed => () => (seed = (seed * 9301 + 49297) % 233280) / 233280)(42);
      const genders = ["Femenino", "Masculino"];
      const ages = ["Niño", "Adulto Joven", "Adulto", "Senior"];
      const zones = ["Pasillo","Vitrina","Tienda","Perfumería","Zapatería","Joyería","Carteras","Tane","Caja"];
      const personas = ["Solo","Pareja","Amigos","Familia"];
      function randomHour(){ const r = rand(); if (r < 0.15) return 10 + Math.floor(rand()*3); if (r < 0.55) return 13 + Math.floor(rand()*3); if (r < 0.80) return 16 + Math.floor(rand()*2); return 18 + Math.floor(rand()*3); }
      const ALL_VISITS = (() => {
        const visits = [];
        for (let d=0; d<30; d++){
          const dayBase = 55 + Math.floor(rand()*65);
          for (let i=0; i<dayBase; i++){
            const g = genders[Math.floor(rand()*genders.length)];
            const a = ages[Math.floor(Math.pow(rand(), .6)*ages.length)];
            const p = personas[Math.floor(Math.pow(rand(), .85)*personas.length)];
            const unique = rand() > 0.18;
            const len = 3 + Math.floor(rand()*5);
            const path = [];
            let current = ["Pasillo","Vitrina","Tienda"][Math.floor(rand()*3)];
            for (let k=0; k<len; k++){
              path.push(current);
              const nextCandidates = zones.filter(z => z !== current);
              current = nextCandidates[Math.floor(rand()*nextCandidates.length)];
            }
            const dwell = 7 + Math.round(rand()*26) + (a==="Niño"? -2: a==="Senior"? +3: 0) + (p==="Familia"? +2: 0);
            const startHour = randomHour();
            visits.push({day:d, hour:startHour, gender:g, age:a, persona:p, path, dwell:Math.max(4,dwell), unique});
          }
        }
        return visits;
      })();

      const $ = s => document.querySelector(s);
      const state = { range: 14, genero:"all", edad:"all", zona:"all", persona:"all" };
      const updateChips = () => {
        const chipR = $("#chip-rango"); if (chipR) chipR.textContent = `${state.range} días`;
        const actives = [];
        if (state.genero!=="all") actives.push(state.genero);
        if (state.edad!=="all") actives.push(state.edad);
        if (state.zona!=="all") actives.push(state.zona);
        if (state.persona!=="all") actives.push(state.persona);
        const chip = $("#chip-filtros"); if (chip) chip.textContent = actives.length? actives.join(" · "): "Sin filtros";
      };
      function clearFilters(){
        state.genero = "all"; state.edad = "all"; state.zona = "all"; state.persona = "all";
        $("#f-genero").value = "all"; $("#f-edad").value = "all"; $("#f-zona").value = "all"; $("#f-persona").value = "all";
        updateChips(); renderDashboard();
      }
      resetBtn.addEventListener('click', safe(clearFilters));

      function getFiltered(){
        const start = 30 - state.range;
        return ALL_VISITS.filter(v =>
          v.day>=start &&
          (state.genero==="all" || v.gender===state.genero) &&
          (state.edad==="all" || v.age===state.edad) &&
          (state.zona==="all" || v.path.includes(state.zona)) &&
          (state.persona==="all" || v.persona===state.persona)
        );
      }

      let chLine, chBarZones, chPieGenero, chPieEdad, chHeat, chHist, chFunnel;
      function ensureDashboardCharts(){
        chLine      = chLine      || echarts.init(document.getElementById("ch-trafico-line"));
        chBarZones  = chBarZones  || echarts.init(document.getElementById("ch-zonas-bar"));
        chPieGenero = chPieGenero || echarts.init(document.getElementById("ch-genero-pie"));
        chPieEdad   = chPieEdad   || echarts.init(document.getElementById("ch-edad-pie"));
        chHeat      = chHeat      || echarts.init(document.getElementById("ch-heat-ocup"));
        chHist      = chHist      || echarts.init(document.getElementById("ch-dwell-hist"));
        chFunnel    = chFunnel    || echarts.init(document.getElementById("ch-funnel"));
      }

      function renderDashboard(){
        ensureDashboardCharts();
        const data = getFiltered();
        const prev = ALL_VISITS.filter(v =>
          v.day >= (30 - state.range*2) && v.day < (30 - state.range) &&
          (state.genero==="all" || v.gender===state.genero) &&
          (state.edad==="all" || v.age===state.edad) &&
          (state.zona==="all" || v.path.includes(state.zona)) &&
          (state.persona==="all" || v.persona===state.persona)
        );

        const traficoTotal = data.length, traficoPrev = prev.length || 1;
        const varTraf = ((traficoTotal-traficoPrev)/traficoPrev*100).toFixed(1);
        const unicos = data.filter(v=>v.unique).length, unicosPrev = prev.filter(v=>v.unique).length || 1;
        const varUni = ((unicos-unicosPrev)/unicosPrev*100).toFixed(1);
        const avgDwell = (data.reduce((s,v)=>s+v.dwell,0)/Math.max(1,data.length)).toFixed(2);
        const avgPrev = (prev.reduce((s,v)=>s+v.dwell,0)/Math.max(1,prev.length)).toFixed(2);
        const varDw = (((avgDwell-avgPrev)/avgPrev)*100).toFixed(1);
        const avgZones = (data.reduce((s,v)=>s+new Set(v.path).size,0)/Math.max(1,data.length)).toFixed(2);
        const avgZonesPrev = (prev.reduce((s,v)=>s+new Set(v.path).size,0)/Math.max(1,prev.length)).toFixed(2);
        const varZones = (((avgZones-avgZonesPrev)/avgZonesPrev)*100).toFixed(1);
        const conv = data.filter(v=>v.path.includes("Caja")).length;
        const convPrev = prev.filter(v=>v.path.includes("Caja")).length || 1;
        const convRate = (conv/Math.max(1,traficoTotal)*100).toFixed(1);
        const convVar = (((conv/Math.max(1,traficoTotal)) - (convPrev/Math.max(1,traficoPrev)))/(convPrev/Math.max(1,traficoPrev))*100).toFixed(1);
        const bounce = data.filter(v=> new Set(v.path).size <= 2 ).length;
        const bounceRate = (bounce/Math.max(1,traficoTotal)*100).toFixed(1);
        const bouncePrev = prev.filter(v=> new Set(v.path).size <= 2 ).length || 1;
        const bounceVar = (((bounce/Math.max(1,traficoTotal)) - (bouncePrev/Math.max(1,traficoPrev)))/(bouncePrev/Math.max(1,traficoPrev))*100).toFixed(1);
        const recir = data.filter(v=> v.path.some((z,i,arr)=> i>0 && arr.slice(0,i).includes(z)) ).length;
        const recirRate = (recir/Math.max(1,traficoTotal)*100).toFixed(1);
        const recirPrev = prev.filter(v=> v.path.some((z,i,arr)=> i>0 && arr.slice(0,i).includes(z)) ).length || 1;
        const recirVar = (((recir/Math.max(1,traficoTotal)) - (recirPrev/Math.max(1,traficoPrev)))/(recirPrev/Math.max(1,traficoPrev))*100).toFixed(1);
        const byHourCounts = Array.from({length:12}, (_,i)=>({h:10+i, c:0}));
        data.forEach(v=>{ const idx=v.hour-10; if(byHourCounts[idx]) byHourCounts[idx].c++; });
        const peak = byHourCounts.reduce((a,b)=> b.c>a.c? b:a, {h:"–",c:0});

        $("#kpi-trafico").textContent = traficoTotal.toLocaleString("es-CL");
        $("#kpi-trafico-var").textContent = (varTraf>=0? "▲ ":"▼ ") + Math.abs(varTraf)+"%";
        $("#kpi-trafico-var").className = "delta "+(varTraf>=0? "up":"down");
        $("#kpi-unicos").textContent = unicos.toLocaleString("es-CL");
        $("#kpi-unicos-var").textContent = (varUni>=0? "▲ ":"▼ ") + Math.abs(varUni)+"%";
        $("#kpi-unicos-var").className = "delta "+(varUni>=0? "up":"down");
        $("#kpi-permanencia").textContent = avgDwell+" min";
        $("#kpi-permanencia-var").textContent = (varDw>=0? "▲ ":"▼ ") + Math.abs(varDw)+"%";
        $("#kpi-permanencia-var").className = "delta "+(varDw>=0? "up":"down");
        $("#kpi-zonas").textContent = avgZones;
        $("#kpi-zonas-var").textContent = (varZones>=0? "▲ ":"▼ ") + Math.abs(varZones)+"%";
        $("#kpi-zonas-var").className = "delta "+(varZones>=0? "up":"down");
        $("#kpi-conv-caja").textContent = convRate+"%";
        $("#kpi-conv-caja-var").textContent = (convVar>=0? "▲ ":"▼ ") + Math.abs(convVar)+"%";
        $("#kpi-conv-caja-var").className = "delta "+(convVar>=0? "up":"down");
        $("#kpi-bounce").textContent = bounceRate+"%";
        $("#kpi-bounce-var").textContent = (bounceVar<=0? "▲ ":"▼ ") + Math.abs(bounceVar)+"%";
        $("#kpi-bounce-var").className = "delta "+(bounceVar<=0? "up":"down");
        $("#kpi-recir").textContent = recirRate+"%";
        $("#kpi-recir-var").textContent = (recirVar>=0? "▲ ":"▼ ") + Math.abs(recirVar)+"%";
        $("#kpi-recir-var").className = "delta "+(recirVar>=0? "up":"down");
        $("#kpi-peak-hour").textContent = peak.h+":00";
        $("#kpi-peak-hour-note").textContent = peak.c? `${peak.c} visitas` : "–";
        $("#kpi-peak-hour-note").className = "delta up";

        const byDay = Array.from({length: state.range}, (_,i)=>30-state.range+i);
        const seriesDay = byDay.map(d => data.filter(v=>v.day===d).length);
        chLine.setOption({ tooltip:{trigger:'axis'}, grid:{left:36,right:16,top:20,bottom:28}, xAxis:{type:'category', data: byDay.map(d=>"D"+(d+1)), boundaryGap:false}, yAxis:{type:'value'}, dataZoom:[{type:'inside'},{type:'slider'}], series:[{type:'line', smooth:true, data:seriesDay, areaStyle:{}}] });

        const zoneCounts = Object.fromEntries(zones.map(z=>[z,0])); data.forEach(v=>v.path.forEach(z => zoneCounts[z]++));
        const topZ = Object.entries(zoneCounts).sort((a,b)=>b[1]-a[1]).slice(0,7);
        chBarZones.setOption({ tooltip:{trigger:'item'}, grid:{left:80,right:18,top:14,bottom:22}, xAxis:{type:'value'}, yAxis:{type:'category', data: topZ.map(z=>z[0])}, series:[{type:'bar', data: topZ.map(z=>z[1])}] });
        chBarZones.off('click'); chBarZones.on('click', (p)=>{ $("#f-zona").value = p.name; state.zona = p.name; updateChips(); renderDashboard(); });

        const heatMap = []; const zoneIndex = Object.fromEntries(zones.map((z,i)=>[z,i])); const gridM = Array.from({length:12},()=> Array(zones.length).fill(0));
        data.forEach(v=>{ const perStop = v.dwell / v.path.length; v.path.forEach(z=>{ const h=v.hour; const hIdx=h-10; if(gridM[hIdx]&& zoneIndex[z]!=null){ gridM[hIdx][zoneIndex[z]] += perStop; } }); });
        for(let h=10; h<=21; h++){ zones.forEach((z,zi)=>{ const val = Math.round(gridM[h-10][zi]); heatMap.push([zi, h-10, val]); }); }
        chHeat.setOption({ tooltip:{position:'top', formatter:(p)=> `${zones[p.value[0]]} · ${10+p.value[1]}:00<br/><b>${p.value[2]} min</b>`}, grid:{left:90,right:16,top:30,bottom:40}, xAxis:{type:'category', data:zones, splitArea:{show:true}}, yAxis:{type:'category', data:Array.from({length:12},(_,i)=> (10+i)+":00"), splitArea:{show:true}}, visualMap:{min:0, max:Math.max(20, Math.ceil(Math.max(...heatMap.map(v=>v[2])))), calculable:true, orient:'horizontal', left:'center', bottom:0}, series:[{type:'heatmap', data:heatMap}] });

        const gCount = genders.map(g=>({name:g, value:data.filter(v=>v.gender===g).length}));
        chPieGenero.setOption({ tooltip:{trigger:'item'}, series:[{type:'pie', radius:['40%','70%'], avoidLabelOverlap:false, data:gCount, label:{formatter:'{b}: {d}%'}}] });

        const eCount = ages.map(a=>({name:a, value:data.filter(v=>v.age===a).length}));
        chPieEdad.setOption({ tooltip:{trigger:'item'}, series:[{type:'pie', radius:['40%','70%'], data:eCount, label:{formatter:'{b}: {d}%'}}] });

        const buckets = new Array(9).fill(0); data.forEach(v=>{ const idx=Math.min(8, Math.floor(v.dwell/5)); buckets[idx]++; });
        chHist.setOption({ tooltip:{trigger:'axis', formatter:(p)=>{const i=p[0].dataIndex; const low=i*5; const high=i===8? '+': (i*5+4); return `${low}${high==='+'?'+': '–'+high} min: <b>${p[0].data}</b>`;}}, grid:{left:46,right:16,top:20,bottom:28}, xAxis:{type:'category', data:['0–4','5–9','10–14','15–19','20–24','25–29','30–34','35–39','40+']}, yAxis:{type:'value'}, series:[{type:'bar', data:buckets}] });

        const atEntrada = data.filter(v=> v.path[0]==='Pasillo' || v.path[0]==='Vitrina').length;
        const atTienda = data.filter(v=> v.path.includes('Tienda')).length;
        const atCategorias = data.filter(v=> v.path.some(z=> ['Perfumería','Zapatería','Joyería','Carteras','Tane'].includes(z))).length;
        const atCaja = data.filter(v=>v.path.includes("Caja")).length;
        chFunnel.setOption({ tooltip:{trigger:'item', formatter:(p)=> `${p.name}: <b>${p.value}</b> (${(p.value/Math.max(1,traficoTotal)*100).toFixed(1)}%)`},
          series:[{type:'funnel', sort:'descending', label:{show:true, formatter:'{b}: {c}'},
            data:[ {name:'Entrada (Pasillo/Vitrina)', value:atEntrada}, {name:'Tienda', value:atTienda}, {name:'Categorías', value:atCategorias}, {name:'Caja', value:atCaja} ]
          }]} );

        const insights = [];
        const topZone = topZ[0] ? `${topZ[0][0]} (${topZ[0][1]} hits)` : null;
        if (topZone) insights.push(`La zona con mayor interacción es <b>${topZone}</b>.`);
        insights.push(`La conversión a Caja es <b>${convRate}%</b>${state.zona!=='all'? ' (filtrada por '+state.zona+')':''}.`);
        insights.push(`Hora pico: <b>${peak.h}:00</b> con <b>${peak.c}</b> visitas.`);
        insights.push(`Bounce (≤2 zonas): <b>${bounceRate}%</b>.`);
        insights.push(`Recirculación: <b>${recirculación=recirRate}%</b>`.replace('recirculación','Recirculación'));
        document.getElementById('insights-list').innerHTML = insights.map(x=>`<li>${x}</li>`).join('');
      }

      /* === Export CSV opcional (si lo necesitas, añade un botón) === */
      function exportCSV(){
        const rows = getFiltered().map(v=>({ dia:v.day+1, hora:v.hour, genero:v.gender, edad:v.age, persona:v.persona, dwell:v.dwell, path:v.path.join('>') }));
        const header = Object.keys(rows[0]||{dia:'',hora:'',genero:'',edad:'',persona:'',dwell:'',path:''}).join(',');
        const body = rows.map(r=> Object.values(r).join(',')).join('\n');
        const blob = new Blob([header+'\n'+body], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='palacio_centro_p1_dataset.csv'; a.click(); URL.revokeObjectURL(url);
      }
      // Si luego agregas un botón de export, llama a exportCSV()

      /* === Resize de charts al cambiar layout === */
      function forceResize(){ [chLine,chBarZones,chPieGenero,chPieEdad,chHeat,chHist,chFunnel].filter(Boolean).forEach(c=>c.resize()); }
      forceResizeSoon = ()=> setTimeout(forceResize, 80);

      window.addEventListener('resize', safe(forceResizeSoon));

      /* === Eventos de filtros (aplican al cambiar cada select) === */
      ["f-fecha","f-genero","f-edad","f-zona","f-persona"].forEach(id=>{
        document.getElementById(id).addEventListener('change', safe(()=>{
          state.range = +document.getElementById("f-fecha").value;
          state.genero = document.getElementById("f-genero").value;
          state.edad = document.getElementById("f-edad").value;
          state.zona = document.getElementById("f-zona").value;
          state.persona = document.getElementById("f-persona").value;
          updateChips();
          renderDashboard();
          forceResizeSoon();
        }));
      });

      /* === Botón “Aplicar” simplemente cierra el drawer (ya aplicamos on-change) === */
      applyBtn.addEventListener('click', safe(()=>{
        // Actualiza etiqueta de fecha fake (opcional)
        const r = document.getElementById('f-fecha').value;
        const map = {7:'Últimos 7 días',14:'Últimos 14 días',30:'Últimos 30 días'};
        document.getElementById('date-range-label').textContent = map[r] || map[14];
        closeFilters();
      }));

      // Render inicial
      requestAnimationFrame(safe(()=>{
        updateChips();
        renderDashboard();
        forceResizeSoon();
      }));
    }));
  })();
  </script>
</body>
</html>
